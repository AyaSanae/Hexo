---
title: TCP/IP (1)概述
date: 2020-08-022 11:15
categories:
    - TCP/IP
    - Network
tags:
    - TCP/IP
cover: /assets/tcpip1.jpeg
comments: true
---
# 0x01 分层
TCP/IP，是一组不同层次上的多个协议的组合。TCP/IP通常被认为是一个四层协议系统.
| 分层    | 包含对象         |
| :------: | :--------------------: |
| 应用层 | Telnet,FTP，E-Mail等 |
| 运输层 | TCP和UDP            |
| 网络层 | IP,ICMP,IGMP等      |
| 链路层 | 驱动程序和接口卡 |

> 其中:运输层,网络层,链路层都被封装操作系统的在内核里.

简介:
- 应用层: 处理特定的应用程序细节.
- 运输层: 为两台主机上的应用程序提供端到端的通讯.
- 网络层: 处理分组在网络中的活动,例如:分组选路.
- 链路层: 处理与电缆(或其他任何传输媒介)的物理接口细节.

## 实例:两台运行FTP的主机
![avatar](/assets/tcpip/1-2.png)
- 大多数的网络应用程序都被设计成客户-服务器模式.
- 双方都有对应的一个或多个协议进行通讯.
- 应用程序通常是用户进程,而下三层一般在内核执行.
- 应用层关系应用程序的细节,也就是说在编写需要网络通讯的程序时,只需要调用下三层的API即可,下三层处理通讯细节.

![avatar](/assets/tcpip/1-3.png)
- 端系统:即终端.如:PC,服务器.
- 中间系统:例如路由器.
- 应用层和传输层使用端到端(End-To-End)的协议.
- 网络层提供的是逐跳的(Hop-To-Hop)协议.如:图1-2的第三层,有PC-路由器-Server.

# 0x02 TCP/IP的分层
在TCP/IP协议族中，有很多种协议,如下:
![avatar](/assets/tcpip/1-4.png)
TCP/UDP是两种最为著名的运输层协议,TCP/UDP基于网络层上的IP协议.
> 数据报: 指从发送方传输到接收方的一个信息单元(例如，发送方指定的一定字节数的信息).
- 虽然TCP使用不可靠的IP服务，但它却提供一种可靠的运输层服务.
- UDP为应用程序发送和接收数据报,但是比起TCP,UDP是不可靠的,因为它不能保证数据报能安全无误地到达最终目的.
- 网络层上的主要协议是IP,同时被TCP和UDP使用,TCP和UDP的每组数据都通过端系统和每个中间路由器中的IP层在互联网上进行传输.
- ICMP是IP协议的附属协议.IP层用它来与其他主机路由器交换错误报文和其他重要信息.
- IGMP是互联网组管理协议,它用来把一个UDP数据报多播到多个主机.

- ARP(地址解析协议)和RARP(逆向地址解析协议)是某些网络接口(如以太网和令牌环网)使用的特殊协议,用来转换IP层和网络接口层使用的协议.

# 0x04 地址
互联网上的每个接口都必须有唯一的Internet地址(IP地址),就像现实中的地址一样,是唯一的.
IP地址并不采用平面形式的地址空间,如1,2,3等.而是更加复杂的结构,有五类,如下:
![avatar](/assets/tcpip/1-5.png)
这些32位的地址通常写成四个十进制的数，其中每个整数对应一个字节。这种表示方法称作“点分十进制表示法(Dotted decimal notation)”

区分各类地址的最简单方法是看它的第一个十进制整数。下图列出了各类地址的起止范围，其中第一个十进制整数用加黑字体表示.
![avatar](/assets/tcpip/1-6.png)
由于互联网上的每个接口都有唯一的IP地址,所以必须要有一个管理机构来给互联网上的的网络分配IP地址.这个管理机构就是互联网络信息中心( Internet Network Information Centre),称作InterNIC。InterNIC只分配网络号.主机号的分配由系统管理员来负责.
>1993年4月1日,InterNIC成立.现在,NIC只负责处理国防数据网的注册请求,所有其他的Internet用户注册请求均由InterNIC负责处理,其网址是：rs.internic.net
>
>事实上InterNIC由三部分组成:注册服务（rs.internic.net),目录和数据库服务(ds.internic.net),以及信息服务(is.internic.net).

有三类IP地址:单播地址(目的为单个主机),广播地址(目的端为给定网络上的所有主机),以及多播地址(目的端为同一组内的所有主机)

# 0x05 域名
尽管通过IP地址可以识别主机上的网络接口，进而访问主机，但是人们最喜欢使用的还是主机名。在TCP/IP领域中，域名系统（DNS）是一个分布的数据库，由它来提供IP地址和主机名之间的映射信息。

# 0x06 封装
>TCP段:TCP传给IP的数据单元称作TCP报文段.
>
>IP数据报:IP传给网络接口层的数据单元称作IP数据报,准确来说应该叫分组,分组既可以是一个IP数据报,也可以是IP数据报的一个片.
>
>帧:通过以太网传输的比特流称作帧.

当应用程序用TCP传送数据时,数据被送入协议栈中,然后逐个通过每一层直到被当作一串比特流送入网络.
其中每一层对收到的数据都要增加一些首部信息(有时还要增加尾部信息).
![avatar](/assets/tcpip/1-7.png)
- 帧头和帧尾下面所标注的数字是典型以太网帧首部的字节长度.
- 以太网数据帧的物理特性是其长度必须在46～1500字节之间.
- 所有的Internet标准和大多数有关TCP/IP的书都使用octet这个术语来表示字节

   *octet和byte的差异:
   在传统的二进制数字概念中，1 byte（字节）=8 bit（位）。大多数因特网标准使用八位组（octet）这个术语而不是使用字节来表示8位的量。该术语起始于TCP/IP发展的早期，当时许多早期的工作是在诸如DEC－10这样的系统上进行的，然而这些系统的结构使用的字节(byte)长度是10位（bit）,因此出现了octet的单位，即准确定义 1 octet = 8 bit。 --百度百科*

UDP数据与TCP数据基本一致.唯一不同的就是UDP传给IP的信息单元叫做UDP数据报,且UDP的首部长为8字节.

由于数据要由最顶层的应用层往下传数据,其中TCP,UDP,ICMP,IGMP都要向IP传数据,因此IP需要在生成的IP首部中加入某种标识,以表明数据属于哪一层.IP在首部中存入一个长度为8bit的数值,称作协议域.1表示为ICMP协议,2表示为IGMP协议,6表示为TCP协议,17表示为UDP协议.

类似地,许多应用程序都可以使用TCP或UDP来传送数据.运输层协议在生成报文首部时要存入一个应用程序的标识符.TCP和UDP都用一个16bit的端口号来表示不同的应用程序.TCP和UDP把源端口号和目的端口号分别存入报文首部中.
同理,网络接口分别要发送和接收IP,ARP和RARP的数据,所以也要有某种标识,以指明生成数据的网络层协议,所以,以太网的帧首部也有一个16bit的帧类型域.

# 0x07 分用
当目标主机接收到一个以太数据帧时,数据就由最底层的链路层往上传直至应用层.往上传的同时去掉各层协议加上的报文首部,每层协议盒都要去检查报文首部中的协议标识,以确定接收数据的上层协议这个过程称作分用,如下图:
![avatar](/assets/tcpip/1-8.png)
- 因为ICMP,IGMP是IP的附属协议,在同一层,上图把他们放在IP上面是因为他们的报文,被封装到了IP数据报中,所以定位ICMP和IGMP是一件棘手的事.
- 对于ARP和RARP也有类似的难题,在这里把它们放在以太网设备驱动程序的上方,这是因为它们和IP数据报一样,都有各自的以太网数据帧类型.

# 0x08 客户-服务器模型
大部分网络应用程序在编写时都假设一端是客户,另一端是服务器,其目的是为了让服务器为客户提供一些特定的服务.
可以将这种服务分为两种类型：重复型或并发型.
重复型服务器通过以下步骤进行交互:
1. 等待客户请求到来
2. 处理请求
3. 发送响应给客户
4. 回到第一步
这里很明显,这是单路的,当有一个请求时就不能处理另一个请求.

并发型服务器采用以下步骤:
1. 等待客户请求到来
2. 启动一个新的服务器来处理这个客户的请求.在这期间可能生成一个新的进程,任务或线程,并依赖底层操作系统的支持.这步骤如何进行取决于操作系统.生成的新服务器对客户的全部请求进行处理.处理结束后,终止这个新服务器.
3. 回到第一步

并发服务器的优点在于它是利用生成其他服务器的方法来处理客户的请求.也就是说,每个客户都有它自己对应的服务器.如果操作系统允许多任务,那么就可以同时为多个客户服务.

一般来说,TCP服务器是并发的,而UDP服务器是重复的,但也存在一些例外.

# 0x09 端口号
服务器一般都是通过知名端口号来识别的,端口号就像房子的门牌号.
例如,对于每个TCP/IP实现来说,FTP服务器的TCP端口号都是21,每个Telnet服务器的TCP端口号都是23,每个TFTP (简单文件传送协议)服务器的UDP端口号都是69.任何TCP/IP实现所提供的服务都用知名的1～1023之间的端口号这些知名端口号由Internet号分配机构(Internet Assigned Numbers Authority, IANA)来管理.

到1992年为止,知名端口号介于1～255之间.256～1023之间的端口号通常都是由Unix系统占用,以提供一些特定的Unix服务—也就是说,提供一些只有Unix系统才有的,而其他操作系统可能不提供的服务。现在IANA管理1～1023之间所有的端口号。

Internet扩展服务与Unix特定服务之间的一个差别就是Telnet和Rlogin.他们二者都允许通过计算机网络登录到其他主机上.Telnet是采用端口号为23的TCP/IP标准且几乎可以在所有操作系统上进行实现.相反.Rlogin最开始时只是为Unix系统设计的（尽管许多非Unix系统现在也提供该服务）,因此在80年代初，它的有名端口号为513。

客户端通常对它所使用的端口号并不关心,只需保证该端口号在本机上是唯一的就可以了.客户端口号又称作临时端口号（即存在时间很短暂）.这是因为它通常只是在用户运行该客户程序时才存在,而服务器则只要主机开着的,其服务就运行.

大多数TCP/IP实现给临时端口分配1024～5000之间的端口号.大于5000的端口号是为其他服务器预留的(Internet上并不常用的服务).

# 0x10 RFC
所有关于Internet的正式标准都以RFC(Request for Comment)文档出版.另外,大量的RFC并不是正式的标准,出版的目的只是为了提供信息.RFC的篇幅从1页到200页不等,每一项都用一个数字来标识,如RFC1122,数字越大说明RFC的内容越新.

所有的RFC都可以通过电子邮件或用FTP从Internet上免费获取.如果发送下面这份电子邮件,就会收到一份获取RFC的方法清单:

    To: rfc-info@ISI.EDU
    Subject: getting rfcs
    help: ways_to_get_rfcs

 # 0x11 标准的简单服务
 有一些标准的简单服务几乎每种实现都要提供,客户程序通常选择Telnet.
 ![avatar](/assets/tcpip/1-9.png)
 - 当使用TCP和UDP提供相同的服务时,一般选择相同的端口号.

 *如果仔细检查这些标准的简单服务以及其他标准的TCP/IP服务（如Telnet、FTP、SMTP等）的端口号时，我们发现它们都是奇数。这是有历史原因的，因为这些端口号都是从NCP端口号派生出来的（NCP，即网络控制协议，是ARPANET的运输层协议，是TCP的前身）。NCP是单工的，不是全双工的，因此每个应用程序需要两个连接，需预留一对奇数和偶数端口号。当TCP和UDP成为标准的运输层协议时，每个应用程序只需要一个端口号，因此就使用了NCP中的奇数.　　--百度百科*

# 0x12 小结

- 本文快速地浏览了TCP/IP协议族,介绍了在后面的章节中将要详细讨论的许多术语和协议.

- TCP/IP协议族分为四层:链路层,网络层,运输层和应用层,每一层各有不同的责任.

- 在TCP/IP中,网络层和运输层之间的区别是最为关键的:网络层(IP)提供点到点的服务,而运输层(TCP和UDP)提供端到端的服务.

- 一个互联网是网络的网络.构造互联网的共同基石是路由器,它们在IP层把网络连在一起.第一个字母大写的Internet是指分布在世界各地的大型互联网,其中包括1万多个网络和超过100万台主机.

- 在一个互联网上,每个接口都用IP地址来标识,尽管用户习惯使用主机名而不是IP地址.域名系统为主机名和IP地址之间提供动态的映射.端口号用来标识互相通信的应用程序.服务器使用知名端口号,而客户使用临时设定的端口号.

参照:TCP/IP协议详解卷一